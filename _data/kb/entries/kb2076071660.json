{
  "Document": {
    "DocumentId": 2076071660,
    "Title": "T-SQL Code: Adding/Refreshing Login and User Metadata; CreateUsers.sql; Troubleshooting Orphaned Users",
    "DocumentShortName": null,
    "FileName": null,
    "Path": null,
    "CreateDate": "2005-03-27T09:11:45.207",
    "ModificationDate": "2005-03-27T09:11:45.207",
    "TemplateId": null,
    "SegmentId": 72,
    "IsRoot": false,
    "IsActive": true,
    "SortOrdinal": null,
    "ClientId": null,
    "Tag": null
  },
  "Content": "/*\n\nThis script is inspired by two MS KB articles:\n\n\"PRB: 'Troubleshooting Orphaned Users' Topic in Books Online is Incomplete\"\n\n    http://support.microsoft.com/kb/274188\n\nand\n\n\"HOW TO: Resolve Permission Issues When You Move a Database Between Servers That Are Running SQL Server\"\n\n    http://support.microsoft.com/kb/240872\n\nThese articles remind us that there is difference between a \"login\" (defined at the server level) and a \"user\" (defined at the database level). The login name and the user name are often the same and this can lull us into the assumption that that a login and a user are the same.\n\nA login and a user are linked by a server-specific, security identifier (SID). When a database is moved to a new server (or removed and restored to the same server) this link can be undefined (or broken). This script attempts to define/repair this link.\n\n*/\n--Server level:\nUSE master\nIF NOT EXISTS(SELECT * FROM sysxlogins WHERE name = 'myLogin')\nBEGIN\n    EXECUTE sp_addlogin @loginame='myLogin',@passwd='mYp1wd',@defdb='myDb'\nEND\n\n-- Database level:\nUSE myDb\n\nIF NOT EXISTS(SELECT * FROM sysusers WHERE name = 'myLogin')\nBEGIN\n    EXECUTE sp_grantdbaccess 'myLogin'\n    EXECUTE sp_addrolemember 'db_datareader','myLogin'\n    EXECUTE sp_addrolemember 'db_datawriter','myLogin'\n    EXECUTE sp_addrolemember 'dbWebSolutionsUsers','myLogin'\nEND\nBEGIN\n    EXECUTE sp_change_users_login 'update_one','myLogin','myLogin'\nEND\n",
  "Tag": "kb2076071660"
}