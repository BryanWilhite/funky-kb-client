{
  "Document": {
    "DocumentId": 2076071470,
    "Title": "T-SQL Code: Stored Procedure AutoDTS_complianceDumps; An Example of Running a DTS Package in tSQL",
    "DocumentShortName": null,
    "FileName": null,
    "Path": null,
    "CreateDate": "2007-11-19T15:15:01",
    "ModificationDate": "2007-11-19T15:15:01",
    "TemplateId": null,
    "SegmentId": 72,
    "IsRoot": false,
    "IsActive": true,
    "SortOrdinal": null,
    "ClientId": null,
    "Tag": null
  },
  "Content": "USE compliance\nGO\n\nIF OBJECT_ID('AutoDTS_complianceDumps') IS NOT NULL\nBEGIN\n    DROP PROCEDURE AutoDTS_complianceDumps\n    IF OBJECT_ID('AutoDTS_complianceDumps') IS NOT NULL\n        PRINT '<<< FAILED DROPPING PROCEDURE AutoDTS_complianceDumps >>>'\n    ELSE\n        PRINT '<<< DROPPED PROCEDURE AutoDTS_complianceDumps >>>'\nEND\nGO\n\nCREATE PROCEDURE AutoDTS_complianceDumps\n(\n        @serverName nvarchar(255) = 'BWilhiteBofA'\n    ,   @groupName  nvarchar(255) = '[ALL]'\n    ,   @path       nvarchar(255) = 'c:\\Inetpub\\wwwroot\\dev_Compliance_Support\\data\\FileDump_Compliance\\'\n)\n\nAS\n\n-- Description: Automation of the DTS Package complianceDumps via tSQL.\n/*\n    Note that if SQL Server is not run by a domain-level user (e.g. the\n    SYSTEM account) then do not use UNC paths for the @path parameter. This\n    code can be translated into an ActiveX Script and run as a SQL Server\n    Job if need be:\n\n    Dim objDTSPack\n\n    Set objDTSPack = CreateObject(\"DTS.Package\")\n\n    'Load Package using NT security.\n    Call objDTSPack.LoadFromSQLServer(\"BWilhiteBofA\", , , 256, , , , \"complianceDumps\")\n\n    'Set Global Variables.\n    objDTSPack.GlobalVariables(\"g_strGroupName\").Value = \"[ALL]\"\n    objDTSPack.GlobalVariables(\"g_strCSVActivityPath\").Value = \"\\\\bwilhitebofa\\FileDump_Compliance\\ActivityReport.csv\"\n    objDTSPack.GlobalVariables(\"g_strCSVExceptionPath\").Value = \"\\\\bwilhitebofa\\FileDump_Compliance\\ExceptionReport.csv\"\n    'Note that we are using UNC's for the g_strCSV[...] global variables\n    'as a domain-level user is running SQL Server Agent.\n\n    'Begin.\n    objDTSPack.FailOnError = True\n    objDTSPack.WriteCompletionStatusToNTEventLog = True\n\n    objDTSPack.Execute\n\n    'Clean up.\n    Set objDTSPack = Nothing\n\n    References:\n    DTS Packages & OLE Stored Procedures\n    http://www.swynk.com/friends/green/dtsole.asp\n*/\n\n-- Developer: Bryan D. Wilhite\n\nSET NOCOUNT ON\n\nDECLARE\n    @token                              int\n,   @hresult                            int\n,   @context                            int\n,   @progID                             nvarchar(255)\n,   @errSrc                             nvarchar(255)\n,   @errDescription                     nvarchar(255)\n,   @isObject                           bit\n,   @methodCall                         nvarchar(512)\n\n,   @DTSSQLStgFlag_UseTrustedConnection nvarchar(4)\n,   @CSVActivityPath                    nvarchar(512)\n,   @CSVExceptionPath                   nvarchar(512)\n\nSET @DTSSQLStgFlag_UseTrustedConnection = '256'\nSET @CSVActivityPath = @path + 'ActivityReport.csv'\nSET @CSVExceptionPath = @path + 'ExceptionReport.csv'\n\nSET @context = 1\n/*\n    1 = In-process (.dll) OLE server only\n    4 = Local (.exe) OLE server only\n    5 = Both in-process and local OLE server allowed\n\n    Note: DTS runs in process with SQL Server so its creation context must be 1.\n*/\n\nSET @isObject = 0\nSET @progID = 'DTS.Package'\n\n-- Create DTS object.\nEXECUTE @hresult = sp_OACreate @progID=@progID, @objecttoken=@token OUTPUT, @context=@context\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token, @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\nELSE\nBEGIN\n    SET @isObject = 1\nEND\n\n-- Load Package using NT security.\nSET @methodCall = 'LoadFromSQLServer(ServerName:=\"' + @serverName + '\", PackageName:=\"complianceDumps\", Flags:=' + @DTSSQLStgFlag_UseTrustedConnection + ')'\nEXECUTE @hresult = sp_OAMethod @objecttoken=@token, @methodname=@methodCall\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\n\n-- Set Package Properties.\nEXECUTE @hresult = sp_OASetProperty @objecttoken=@token, @propertyname='FailOnError', @newvalue=TRUE\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\n\nEXECUTE @hresult = sp_OASetProperty @objecttoken=@token, @propertyname='WriteCompletionStatusToNTEventLog', @newvalue=TRUE\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\n\n\n-- Set Global Variables.\nEXECUTE @hresult = sp_OASetProperty @objecttoken=@token, @propertyname='GlobalVariables(\"g_strGroupName\").Value', @newvalue=@groupName\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\n\nEXECUTE @hresult = sp_OASetProperty @objecttoken=@token, @propertyname='GlobalVariables(\"g_strCSVActivityPath\").Value', @newvalue=@CSVActivityPath\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\n\nEXECUTE @hresult = sp_OASetProperty @objecttoken=@token, @propertyname='GlobalVariables(\"g_strCSVExceptionPath\").Value', @newvalue=@CSVExceptionPath\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\n\n-- Execute.\nEXECUTE @hresult = sp_OAMethod @objecttoken=@token, @methodname='Execute'\nIF @hresult <> 0\nBEGIN\n    EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n    SELECT\n        PROGID        = @progID\n    ,   HRESULT       = @hresult\n    ,   SOURCE        = @errSrc\n    ,   [Description] = @errDescription\nEND\n\n-- Clean up.\nIF @isObject = 1\nBEGIN\n    EXECUTE @hresult = sp_OADestroy @objecttoken=@token\n    IF @hresult <> 0\n    BEGIN\n        EXECUTE sp_OAGetErrorInfo @objecttoken=@token,  @source=@errSrc, @description=@errDescription OUTPUT\n        SELECT\n            PROGID        = @progID\n        ,   HRESULT       = @hresult\n        ,   SOURCE        = @errSrc\n        ,   [Description] = @errDescription\n    END\nEND\n\nGO\n\nGRANT EXECUTE ON AutoDTS_complianceDumps TO dbWebSolutionsUsers\nGO\n\nIF OBJECT_ID('AutoDTS_complianceDumps') IS NOT NULL\n    PRINT '<<< CREATED PROCEDURE AutoDTS_complianceDumps >>>'\nELSE\n    PRINT '<<< FAILED CREATING PROCEDURE AutoDTS_complianceDumps >>>'\nGO\n",
  "Tag": "kb2076071470"
}